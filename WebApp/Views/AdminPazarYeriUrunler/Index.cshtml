@* 
@using System.Globalization
@using WebApp.Models
@using Newtonsoft.Json
@using static WebApp.Controllers.AdminPazarYeriUrunlerController

@{
    ViewData["Title"] = "Pazar Yeri Ürünleri Yönetimi";
    Layout = "~/Views/Shared/_LayoutWebAdmin.cshtml";
}

<style>
    .modern-wrapper {
        padding: 20px;
    }

    .modern-panel {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        transition: box-shadow 0.3s ease;
        margin-bottom: 30px;
        margin-top: 30px;
    }

        .modern-panel:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

    .panel-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 25px;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.5px;
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .panel-content {
        padding: 25px;
    }

    .btn-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }

    .modern-table {
        margin-top: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 0 1px #e0e0e0;
    }

        .modern-table thead {
            background: #f8f9fa;
        }

        .modern-table th {
            padding: 15px;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .modern-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .modern-table tbody tr {
            transition: background-color 0.2s ease;
        }

            .modern-table tbody tr:hover {
                background-color: #f8f9fa;
            }

    .btn-action {
        padding: 7px 14px;
        border-radius: 6px;
        border: none;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-right: 5px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-action-update {
        background: #38a169;
        color: white;
    }

        .btn-action-update:hover {
            background: #2f855a;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(56, 161, 105, 0.3);
        }

    .btn-action-delete {
        background: #f56565;
        color: white;
    }

        .btn-action-delete:hover {
            background: #e53e3e;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(245, 101, 101, 0.3);
        }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #cbd5e0;
        }

    .content-text {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #4a5568;
    }

    .modal-content {
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 15px 20px;
    }

    .modal-body {
        padding: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-control {
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        padding: 8px;
        width: 100%;
    }

    media (max-width: 768px) {
        .modern-table

    {
        font-size: 14px;
    }

    .btn-action {
        padding: 5px 10px;
        font-size: 11px;
    }

    .content-text {
        max-width: 150px;
    }

    }
</style>

<section class="modern-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <div class="modern-panel">
                <div class="panel-header">
                    <i class="fa fa-shopping-cart"></i>
                    <span>Pazar Yeri Ürünleri</span>
                    @{
                        var pazaryerleri = ViewBag.Pazaryerleri as List<PazarYerleri>;
                        int? selectedPazarYeriId = ViewBag.SelectedPazarYeriId as int?;
                    }
                    @if (selectedPazarYeriId != null && pazaryerleri != null)
                    {
                        var apiType = pazaryerleri.FirstOrDefault(p => p.Id == selectedPazarYeriId)?.Adi.ToLower();
                        if (apiType?.Contains("farma borsa") == true || apiType?.Contains("n11") == true)
                        {
                            <button class="btn-modern" data-toggle="modal" data-target="#addProductModal">
                                <i class="fa fa-plus"></i>
                                <span>Ürün Ekle</span>
                            </button>
                        }
                    }
                </div>
                <div class="panel-content">
                    <div class="content-header">
                        <div class="row">
                            <div class="col-md-6">
                                <select id="pazarYeriSelect" class="form-control" onchange="location.href='/AdminPazarYeriUrunler/Index?pazarYeriId='+this.value">
                                    <option value="">Pazar Yeri Seçiniz</option>
                                    @foreach (var pazarYeri in ViewBag.Pazaryerleri)
                                    {
                                        <option value="@pazarYeri.Id" @(ViewBag.SelectedPazarYeriId == pazarYeri.Id ? "selected" : "")>@pazarYeri.Adi</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    @if (ViewBag.Products != null && ViewBag.Products.Count > 0)
                    {
                        <div class="table-container">
                            <table class="table modern-table" id="TblVeriler">
                                <thead>
                                    <tr>
                                        <th>Ürün Adı</th>
                                        <th>Barkod</th>
                                        <th>Fiyat</th>
                                        <th>Stok</th>
                                        <th>Durum</th>
                                        <th style="text-align: center;">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var product in ViewBag.Products)
                                    {
                                        var pazaryerleriListesi = ViewBag.Pazaryerleri as List<PazarYerleri>;
                                        var apiType = pazaryerleriListesi?.FirstOrDefault(p => p.Id == (int)ViewBag.SelectedPazarYeriId)?.Adi.ToLower();
                                        string productId = "";
                                        string productName = "";
                                        string barcode = "";
                                        string price = "";
                                        string stock = "";
                                        string status = "";
                                        object productData = null;

                                        if (apiType.Contains("n11"))
                                        {
                                            var n11Product = product as Product;
                                            productId = n11Product.N11ProductId.ToString();
                                            productName = n11Product.Title;
                                            barcode = n11Product.Barcode;
                                            price = n11Product.SalePrice.ToString("C", CultureInfo.GetCultureInfo("tr-TR"));
                                            stock = n11Product.Quantity.ToString();
                                            status = n11Product.Status;
                                            productData = n11Product;
                                        }
                                        else if (apiType.Contains("farma borsa"))
                                        {
                                            var fbProduct = product as Ilan;
                                            productId = fbProduct.kod.ToString();
                                            productName = fbProduct.urunAd;
                                            barcode = fbProduct.barkod;
                                            price = fbProduct.tutar.ToString("C", CultureInfo.GetCultureInfo("tr-TR"));
                                            stock = fbProduct.adet.ToString();
                                            status = fbProduct.borsadaGoster ? "Aktif" : "Pasif";
                                            productData = fbProduct;
                                        }
                                        <tr data-product='@JsonConvert.SerializeObject(productData)'>
                                            <td class="content-text">@productName</td>
                                            <td class="content-text">@barcode</td>
                                            <td class="content-text">@price</td>
                                            <td class="content-text">@stock</td>
                                            <td class="content-text">@status</td>
                                            <td style="text-align: center;">
                                                <button class="btn-action btn-action-update" onclick="openUpdateModal(@productId, this, '@apiType')">
                                                    <i class="fa fa-edit"></i>
                                                    <span>Güncelle</span>
                                                </button>
                                                <a class="btn-action btn-action-delete" href="/AdminPazarYeriUrunler/Sil/@productId?pazarYeriId=@ViewBag.SelectedPazarYeriId&apiType=@apiType"
                                                   onclick="return confirm('Bu ürünü silmek istediğinizden emin misiniz?');">
                                                    <i class="fa fa-trash"></i>
                                                    <span>Sil</span>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <i class="fa fa-shopping-cart"></i>
                            <h4>Henüz ürün bulunamadı</h4>
                            <p>Pazar yeri seçip ürünleri listeleyebilirsiniz.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Yeni Ürün Ekle</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <input type="hidden" id="apiType" value="">
                        <!-- FarmaBorsa Fields -->
                        <div class="farmaborsa-fields" style="display: none;">
                            <div class="form-group">
                                <label for="fb_urunAd">Ürün Adı</label>
                                <input type="text" class="form-control" id="fb_urunAd" name="fb_urunAd" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_adet">Stok Miktarı</label>
                                <input type="number" class="form-control" id="fb_adet" name="fb_adet" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_maxAdet">Maksimum Satın Alım Adedi</label>
                                <input type="number" class="form-control" id="fb_maxAdet" name="fb_maxAdet" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_op">Operasyonel Kod</label>
                                <input type="number" class="form-control" id="fb_op" name="fb_op" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_tutar">Fiyat (TL)</label>
                                <input type="text" class="form-control" id="fb_tutar" name="fb_tutar" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_borsadaGoster">Borsada Göster</label>
                                <select class="form-control" id="fb_borsadaGoster" name="fb_borsadaGoster" required>
                                    <option value="true">Evet</option>
                                    <option value="false">Hayır</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fb_miad">Son Kullanım Tarihi (YYYY-MM-DD)</label>
                                <input type="text" class="form-control" id="fb_miad" name="fb_miad" placeholder="YYYY-MM-DD" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_miadTip">Son Kullanım Tipi</label>
                                <select class="form-control" id="fb_miadTip" name="fb_miadTip" required>
                                    <option value="0">Normal</option>
                                    <option value="1">Kısa</option>
                                    <option value="2">Yakın</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fb_barkod">Barkod</label>
                                <input type="text" class="form-control" id="fb_barkod" name="fb_barkod">
                            </div>
                            <div class="form-group">
                                <label for="fb_resimUrl">Görsel URL</label>
                                <input type="text" class="form-control" id="fb_resimUrl" name="fb_resimUrl">
                            </div>
                        </div>
                        <!-- n11 Fields -->
                        <div class="n11-fields" style="display: none;">
                            <div class="form-group">
                                <label for="n11_title">Ürün Adı</label>
                                <input type="text" class="form-control" id="n11_title" name="n11_title" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_description">Açıklama</label>
                                <textarea class="form-control" id="n11_description" name="n11_description" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="n11_categoryId">Kategori</label>
                                <select class="form-control" id="n11_categoryId" name="n11_categoryId" required>
                                    <option value="">Kategori Seçiniz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="n11_currencyType">Para Birimi</label>
                                <select class="form-control" id="n11_currencyType" name="n11_currencyType" required>
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="n11_productMainId">Ürün Ana ID</label>
                                <input type="text" class="form-control" id="n11_productMainId" name="n11_productMainId" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_preparingDay">Kargoya Hazırlık Süresi (Gün)</label>
                                <input type="number" class="form-control" id="n11_preparingDay" name="n11_preparingDay" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_shipmentTemplate">Kargo Şablonu</label>
                                <input type="text" class="form-control" id="n11_shipmentTemplate" name="n11_shipmentTemplate" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_maxPurchaseQuantity">Maksimum Satın Alım Adedi</label>
                                <input type="number" class="form-control" id="n11_maxPurchaseQuantity" name="n11_maxPurchaseQuantity">
                            </div>
                            <div class="form-group">
                                <label for="n11_stockCode">Stok Kodu</label>
                                <input type="text" class="form-control" id="n11_stockCode" name="n11_stockCode" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_barcode">Barkod</label>
                                <input type="text" class="form-control" id="n11_barcode" name="n11_barcode">
                            </div>
                            <div class="form-group">
                                <label for="n11_quantity">Stok Miktarı</label>
                                <input type="number" class="form-control" id="n11_quantity" name="n11_quantity" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_imageUrl">Görsel URL</label>
                                <input type="text" class="form-control" id="n11_imageUrl" name="n11_imageUrl">
                            </div>
                            <div class="form-group">
                                <label for="n11_salePrice">Satış Fiyatı (TL)</label>
                                <input type="text" class="form-control" id="n11_salePrice" name="n11_salePrice" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_listPrice">Liste Fiyatı (TL)</label>
                                <input type="text" class="form-control" id="n11_listPrice" name="n11_listPrice" required>
                            </div>
                            <div class="form-group">
                                <label for="n11_vatRate">KDV Oranı</label>
                                <select class="form-control" id="n11_vatRate" name="n11_vatRate" required>
                                    <option value="0">0%</option>
                                    <option value="1">1%</option>
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="n11_attributes">Özellikler (JSON formatında)</label>
                                <textarea class="form-control" id="n11_attributes" name="n11_attributes" placeholder='[{"id": 1, "valueId": null, "customValue": "MarkaAdı"}, ...]'></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-modern">Ekle</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Product Modal -->
    <div class="modal fade" id="updateProductModal" tabindex="-1" role="dialog" aria-labelledby="updateProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateProductModalLabel">Ürün Güncelle</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="updateProductForm">
                        <input type="hidden" id="updateProductId">
                        <input type="hidden" id="updateApiType">
                        <!-- FarmaBorsa Fields -->
                        <div class="farmaborsa-fields" style="display: none;">
                            <div class="form-group">
                                <label for="fb_updateKod">Ürün Kodu</label>
                                <input type="number" class="form-control" id="fb_updateKod" readonly>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateUrunAd">Ürün Adı</label>
                                <input type="text" class="form-control" id="fb_updateUrunAd" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateAdet">Stok Miktarı</label>
                                <input type="number" class="form-control" id="fb_updateAdet" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateMaxAdet">Maksimum Satın Alım Adedi</label>
                                <input type="number" class="form-control" id="fb_updateMaxAdet" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateOp">Operasyonel Kod</label>
                                <input type="number" class="form-control" id="fb_updateOp" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateTutar">Fiyat (TL)</label>
                                <input type="text" class="form-control" id="fb_updateTutar" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateBorsadaGoster">Borsada Göster</label>
                                <select class="form-control" id="fb_updateBorsadaGoster" required>
                                    <option value="true">Evet</option>
                                    <option value="false">Hayır</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateMiad">Son Kullanım Tarihi (YYYY-MM-DD)</label>
                                <input type="text" class="form-control" id="fb_updateMiad" placeholder="YYYY-MM-DD" required>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateMiadTip">Son Kullanım Tipi</label>
                                <select class="form-control" id="fb_updateMiadTip" required>
                                    <option value="0">Normal</option>
                                    <option value="1">Kısa</option>
                                    <option value="2">Yakın</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fb_updateBarkod">Barkod</label>
                                <input type="text" class="form-control" id="fb_updateBarkod">
                            </div>
                            <div class="form-group">
                                <label for="fb_updateResimUrl">Görsel URL</label>
                                <input type="text" class="form-control" id="fb_updateResimUrl">
                            </div>
                        </div>
                        <!-- n11 Fields -->
                        <div class="n11-fields" style="display: none;">
                            <div class="form-group">
                                <label for="n11_updateStockCode">Stok Kodu</label>
                                <input type="text" class="form-control" id="n11_updateStockCode" readonly>
                            </div>
                            <div class="form-group">
                                <label for="n11_updateStatus">Durum</label>
                                <select class="form-control" id="n11_updateStatus" name="n11_updateStatus">
                                    <option value="Active">Aktif</option>
                                    <option value="Suspended">Pasif</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="n11_updatePreparingDay">Kargoya Hazırlık Süresi (Gün)</label>
                                <input type="number" class="form-control" id="n11_updatePreparingDay" name="n11_updatePreparingDay">
                            </div>
                            <div class="form-group">
                                <label for="n11_updateShipmentTemplate">Kargo Şablonu</label>
                                <input type="text" class="form-control" id="n11_updateShipmentTemplate" name="n11_updateShipmentTemplate">
                            </div>
                            <div class="form-group">
                                <label for="n11_updateCurrencyType">Para Birimi</label>
                                <select class="form-control" id="n11_updateCurrencyType" name="n11_updateCurrencyType">
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="n11_updateDeleteProductMainId">Ürün Ana ID'yi Sil</label>
                                <select class="form-control" id="n11_updateDeleteProductMainId" name="n11_updateDeleteProductMainId">
                                    <option value="false">Hayır</option>
                                    <option value="true">Evet</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="n11_updateProductMainId">Ürün Ana ID</label>
                                <input type="text" class="form-control" id="n11_updateProductMainId" name="n11_updateProductMainId">
                            </div>
                            <div class="form-group">
                                <label for="n11_updateDeleteMaxPurchaseQuantity">Maksimum Satın Alım Adedi'ni Sil</label>
                                <select class="form-control" id="n11_updateDeleteMaxPurchaseQuantity" name="n11_updateDeleteMaxPurchaseQuantity">
                                    <option value="false">Hayır</option>
                                    <option value="true">Evet</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="n11_updateMaxPurchaseQuantity">Maksimum Satın Alım Adedi</label>
                                <input type="number" class="form-control" id="n11_updateMaxPurchaseQuantity" name="n11_updateMaxPurchaseQuantity">
                            </div>
                            <div class="form-group">
                                <label for="n11_updateDescription">Açıklama</label>
                                <textarea class="form-control" id="n11_updateDescription" name="n11_updateDescription"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="n11_updateVatRate">KDV Oranı</label>
                                <select class="form-control" id="n11_updateVatRate" name="n11_updateVatRate">
                                    <option value="0">0%</option>
                                    <option value="1">1%</option>
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-modern">Güncelle</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@section Script {
    <script>
        $(document).ready(function () {
            if ($.fn.DataTable && $('#TblVeriler').length > 0) {
                $('#TblVeriler').DataTable({
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Turkish.json"
                    },
                    "pageLength": 10,
                    "order": [[0, "desc"]],
                    "responsive": true,
                    "bDestroy": true
                });
            }

            $('#pazarYeriSelect').change(function () {
                var selectedId = this.value;
                var apiType = getApiType(selectedId);
                $('#apiType').val(apiType);
                toggleModalFields(apiType);
                if (apiType.includes('n11') && selectedId) {
                    loadN11Categories(selectedId);
                }
            });

            $('#addProductModal').on('show.bs.modal', function () {
                var selectedId = $('#pazarYeriSelect').val();
                var apiType = getApiType(selectedId);
                $('#apiType').val(apiType);
                toggleModalFields(apiType);
                clearAddForm();
                if (apiType.includes('n11') && selectedId) {
                    loadN11Categories(selectedId);
                }
            });

            function loadN11Categories(pazarYeriId) {
                $.ajax({
                    url: '/AdminPazarYeriUrunler/GetN11Categories?pazarYeriId=' + pazarYeriId,
                    type: 'GET',
                    success: function (response) {
                        console.log("Categories response:", response);
                        if (response.success) {
                            var $select = $('#n11_categoryId');
                            $select.empty();
                            $select.append('<option value="">Kategori Seçiniz</option>');
                            response.categories.forEach(function (category) {
                                $select.append('<option value="' + category.id + '">' + category.name + '</option>');
                            });
                        } else {
                            alert('Kategoriler yüklenemedi: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Categories AJAX error:", error);
                        alert('Kategoriler yüklenemedi: ' + error);
                    }
                });
            }

            $('#addProductForm').submit(function (e) {
                e.preventDefault();
                var apiType = $('#apiType').val();
                var pazarYeriId = $('#pazarYeriSelect').val();

                if (!pazarYeriId) {
                    alert('Lütfen bir pazar yeri seçin.');
                    return;
                }

                if (apiType.includes('farma borsa')) {
                    if (!$('#fb_urunAd').val() || !$('#fb_adet').val() || !$('#fb_tutar').val()) {
                        alert('Lütfen zorunlu alanları doldurun (Ürün Adı, Stok Miktarı, Fiyat)');
                        return;
                    }
                    var productData = {
                        urunAd: $('#fb_urunAd').val(),
                        adet: parseInt($('#fb_adet').val()),
                        maxAdet: parseInt($('#fb_maxAdet').val()),
                        op: parseInt($('#fb_op').val()),
                        tutar: parseFloat($('#fb_tutar').val().replace(',', '.')),
                        borsadaGoster: $('#fb_borsadaGoster').val() === 'true',
                        miad: $('#fb_miad').val(),
                        miadTip: parseInt($('#fb_miadTip').val()),
                        barkod: $('#fb_barkod').val() || null,
                        resimUrl: $('#fb_resimUrl').val() || null
                    };

                    console.log("Sending Farma Borsa data:", productData);

                    $.ajax({
                        url: '/AdminPazarYeriUrunler/AddFarmaBorsaProduct?pazarYeriId=' + pazarYeriId,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(productData),
                        success: function (response) {
                            console.log("Response received:", response);
                            if (response.success) {
                                alert('Ürün başarıyla eklendi: ' + response.message);
                                $('#addProductModal').modal('hide');
                                location.reload();
                            } else {
                                alert('Hata: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("AJAX error:", error);
                            alert('Hata: ' + error);
                        }
                    });
                } else if (apiType.includes('n11')) {
                    if (!$('#n11_title').val() || !$('#n11_description').val() || !$('#n11_categoryId').val() ||
                        !$('#n11_currencyType').val() || !$('#n11_productMainId').val() ||
                        !$('#n11_preparingDay').val() || !$('#n11_shipmentTemplate').val() ||
                        !$('#n11_stockCode').val() || !$('#n11_quantity').val() ||
                        !$('#n11_salePrice').val() || !$('#n11_listPrice').val() || !$('#n11_vatRate').val()) {
                        alert('Lütfen zorunlu alanları doldurun.');
                        return;
                    }
                    var attributes = [];
                    try {
                        var attributesInput = $('#n11_attributes').val();
                        if (attributesInput) {
                            attributes = JSON.parse(attributesInput);
                        }
                    } catch (e) {
                        alert('Özellikler JSON formatında olmalıdır.');
                        return;
                    }
                    var productData = {
                        title: $('#n11_title').val(),
                        description: $('#n11_description').val(),
                        categoryId: parseInt($('#n11_categoryId').val()),
                        currencyType: $('#n11_currencyType').val(),
                        productMainId: $('#n11_productMainId').val(),
                        preparingDay: parseInt($('#n11_preparingDay').val()),
                        shipmentTemplate: $('#n11_shipmentTemplate').val(),
                        maxPurchaseQuantity: parseInt($('#n11_maxPurchaseQuantity').val()) || null,
                        stockCode: $('#n11_stockCode').val(),
                        barcode: $('#n11_barcode').val() || null,
                        quantity: parseInt($('#n11_quantity').val()),
                        imageUrl: $('#n11_imageUrl').val() || null,
                        attributes: attributes,
                        salePrice: parseFloat($('#n11_salePrice').val().replace(',', '.')),
                        listPrice: parseFloat($('#n11_listPrice').val().replace(',', '.')),
                        vatRate: parseInt($('#n11_vatRate').val())
                    };

                    console.log("Sending n11 data:", productData);

                    $.ajax({
                        url: '/AdminPazarYeriUrunler/AddN11Product?pazarYeriId=' + pazarYeriId,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(productData),
                        success: function (response) {
                            console.log("Response received:", response);
                            if (response.success) {
                                alert('Ürün başarıyla eklendi: ' + response.message);
                                $('#addProductModal').modal('hide');
                                location.reload();
                            } else {
                                alert('Hata: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("AJAX error:", error);
                            alert('Hata: ' + error);
                        }
                    });
                }
            });

            $('#updateProductModal').on('show.bs.modal', function (e) {
                var apiType = $('#updateApiType').val();
                toggleModalFields(apiType);
            });

            $('#updateProductForm').submit(function (e) {
                e.preventDefault();
                var apiType = $('#updateApiType').val();
                var pazarYeriId = $('#pazarYeriSelect').val();

                if (!pazarYeriId) {
                    alert('Lütfen bir pazar yeri seçin.');
                    return;
                }

                if (apiType.includes('farma borsa')) {
                    var productData = {
                        kod: parseInt($('#fb_updateKod').val()),
                        urunAd: $('#fb_updateUrunAd').val(),
                        adet: parseInt($('#fb_updateAdet').val()),
                        maxAdet: parseInt($('#fb_updateMaxAdet').val()),
                        op: parseInt($('#fb_updateOp').val()),
                        tutar: parseFloat($('#fb_updateTutar').val().replace(',', '.')),
                        borsadaGoster: $('#fb_updateBorsadaGoster').val() === 'true',
                        miad: $('#fb_updateMiad').val(),
                        miadTip: parseInt($('#fb_updateMiadTip').val()),
                        barkod: $('#fb_updateBarkod').val(),
                        resimUrl: $('#fb_updateResimUrl').val()
                    };

                    console.log("Sending Farma Borsa update data:", productData);

                    $.ajax({
                        url: '/AdminPazarYeriUrunler/UpdateFarmaBorsaProduct?pazarYeriId=' + pazarYeriId,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(productData),
                        success: function (response) {
                            console.log("Update response:", response);
                            if (response.success) {
                                alert('Ürün başarıyla güncellendi: ' + response.message);
                                $('#updateProductModal').modal('hide');
                                location.reload();
                            } else {
                                alert('Hata: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Update error:", error);
                            alert('Hata: ' + error);
                        }
                    });
                } else if (apiType.includes('n11')) {
                    if (!$('#n11_updateStockCode').val() || !$('#n11_updateVatRate').val()) {
                        alert('Lütfen zorunlu alanları doldurun (Stok Kodu, KDV Oranı).');
                        return;
                    }
                    var productData = {
                        stockCode: $('#n11_updateStockCode').val(),
                        status: $('#n11_updateStatus').val() || null,
                        preparingDay: parseInt($('#n11_updatePreparingDay').val()) || null,
                        shipmentTemplate: $('#n11_updateShipmentTemplate').val() || null,
                        currencyType: $('#n11_updateCurrencyType').val() || null,
                        deleteProductMainId: $('#n11_updateDeleteProductMainId').val() === 'true',
                        productMainId: $('#n11_updateProductMainId').val() || null,
                        deleteMaxPurchaseQuantity: $('#n11_updateDeleteMaxPurchaseQuantity').val() === 'true',
                        maxPurchaseQuantity: parseInt($('#n11_updateMaxPurchaseQuantity').val()) || null,
                        description: $('#n11_updateDescription').val() || null,
                        vatRate: parseInt($('#n11_updateVatRate').val())
                    };

                    console.log("Sending n11 update data:", productData);

                    $.ajax({
                        url: '/AdminPazarYeriUrunler/UpdateN11Product?pazarYeriId=' + pazarYeriId,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(productData),
                        success: function (response) {
                            console.log("Update response:", response);
                            if (response.success) {
                                alert('Ürün başarıyla güncellendi: ' + response.message);
                                $('#updateProductModal').modal('hide');
                                location.reload();
                            } else {
                                alert('Hata: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Update error:", error);
                            alert('Hata: ' + error);
                        }
                    });
                }
            });

            function getApiType(pazarYeriId) {
                if (!pazarYeriId) return '';
                var pazarYerleri = @Html.Raw(JsonConvert.SerializeObject(ViewBag.Pazaryerleri));
                var pazarYeri = pazarYerleri.find(function(p) {
                    return p.Id == pazarYeriId;
                });

                if (pazarYeri) {
                    var name = pazarYeri.Adi.toLowerCase();
                    if (name.includes('n11')) return 'n11';
                    if (name.includes('farma') && name.includes('borsa')) return 'farma borsa';
                    if (name.includes('farmazon')) return 'farmazon';
                }
                return '';
            }

            function toggleModalFields(apiType) {
                $('.farmaborsa-fields').hide();
                $('.n11-fields').hide();

                if (apiType.includes('farma borsa')) {
                    $('.farmaborsa-fields').show();
                } else if (apiType.includes('n11')) {
                    $('.n11-fields').show();
                }
            }

            function clearAddForm() {
                $('#addProductForm')[0].reset();
                $('#n11_categoryId').empty();
                $('#n11_categoryId').append('<option value="">Kategori Seçiniz</option>');
            }

            window.openUpdateModal = function(productId, button, apiType) {
                $('#updateProductId').val(productId);
                $('#updateApiType').val(apiType);
                var productData = $(button).closest('tr').data('product');

                console.log("Opening update modal for:", productData);

                toggleModalFields(apiType);

                if (apiType.includes('farma borsa')) {
                    $('#fb_updateKod').val(productData.kod);
                    $('#fb_updateUrunAd').val(productData.urunAd);
                    $('#fb_updateAdet').val(productData.adet);
                    $('#fb_updateMaxAdet').val(productData.maxAdet);
                    $('#fb_updateOp').val(productData.op);
                    $('#fb_updateTutar').val(productData.tutar);
                    $('#fb_updateBorsadaGoster').val(productData.borsadaGoster.toString());
                    $('#fb_updateMiad').val(productData.miad);
                    $('#fb_updateMiadTip').val(productData.miadTip);
                    $('#fb_updateBarkod').val(productData.barkod);
                    $('#fb_updateResimUrl').val(productData.resimUrl);
                } else if (apiType.includes('n11')) {
                    $('#n11_updateStockCode').val(productData.StockCode);
                    $('#n11_updateStatus').val(productData.Status);
                    $('#n11_updatePreparingDay').val(productData.PreparingDay);
                    $('#n11_updateShipmentTemplate').val(productData.ShipmentTemplate);
                    $('#n11_updateCurrencyType').val(productData.CurrencyType);
                    $('#n11_updateDeleteProductMainId').val(productData.ProductMainId ? 'false' : 'true');
                    $('#n11_updateProductMainId').val(productData.ProductMainId);
                    $('#n11_updateDeleteMaxPurchaseQuantity').val(productData.MaxPurchaseQuantity ? 'false' : 'true');
                    $('#n11_updateMaxPurchaseQuantity').val(productData.MaxPurchaseQuantity);
                    $('#n11_updateDescription').val(productData.Description);
                    $('#n11_updateVatRate').val(productData.VatRate);
                }

                $('#updateProductModal').modal('show');
            }
        });
    </script>
}
 *@