// Index.cshtml
@using System.Globalization
@using WebApp.Models
@using Newtonsoft.Json

@{
    ViewData["Title"] = "Trendyol Ürün Yönetimi";
    Layout = "~/Views/Shared/_LayoutWebAdmin.cshtml";
}

<style>
    .modern-wrapper {
        padding: 20px;
    }

    .modern-panel {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        margin-bottom: 20px;
        margin-top: 20px;
    }

    .panel-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .panel-content {
        padding: 20px;
    }

    .btn-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

    .modern-table {
        margin-top: 15px;
        border-radius: 8px;
        box-shadow: 0 0 0 1px #e0e0e0;
    }

        .modern-table th, .modern-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }

        .modern-table th {
            background: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        .modern-table tbody tr:hover {
            background-color: #f8f9fa;
        }

    .btn-action {
        padding: 6px 12px;
        border-radius: 5px;
        border: none;
        font-size: 12px;
        margin-right: 5px;
    }

    .btn-action-update {
        background: #38a169;
        color: white;
    }

        .btn-action-update:hover {
            background: #2f855a;
        }

    .btn-action-delete {
        background: #f56565;
        color: white;
    }

        .btn-action-delete:hover {
            background: #e53e3e;
        }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #718096;
    }

        .empty-state i {
            font-size: 40px;
            margin-bottom: 15px;
            color: #cbd5e0;
        }

    .modal-content {
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 12px;
    }

    .modal-body {
        padding: 15px;
    }

    .form-group {
        margin-bottom: 12px;
    }

    .form-control {
        border-radius: 5px;
        border: 1px solid #e0e0e0;
        padding: 8px;
        width: 100%;
    }

    media (max-width: 768px) {
        .modern-table th, .modern-table td

    {
        font-size: 13px;
        padding: 10px;
    }

    .btn-action {
        padding: 5px 10px;
        font-size: 11px;
    }

    }

    .form-row {
        margin-bottom: 12px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        box-sizing: border-box;
    }
</style>

<section class="modern-wrapper">
    <div class="modern-panel">
        <div class="panel-header">
            <i class="fa fa-shopping-cart"></i>
            <span>Trendyol Ürünleri</span>
            <button class="btn-modern" data-toggle="modal" data-target="#addProductModal">
                <i class="fa fa-plus"></i> Ürün Ekle
            </button>
        </div>
        <div class="panel-content">
            @if (ViewBag.Products != null && ViewBag.Products.Count > 0)
            {
                <table class="table modern-table" id="TblVeriler">
                    <thead>
                        <tr>
                            <th>Ürün Adı</th>
                            <th>Barkod</th>
                            <th>Fiyat</th>
                            <th>Stok</th>
                            <th>Durum</th>
                            <th style="text-align: center;">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in ViewBag.Products)
                        {
                            var trendyolProduct = product as TrendyolProduct;
                            <tr data-product='@JsonConvert.SerializeObject(trendyolProduct)'>
                                <td>@trendyolProduct.Title</td>
                                <td>@trendyolProduct.Barcode</td>
                                <td>@trendyolProduct.SalePrice.ToString("C", CultureInfo.GetCultureInfo("tr-TR"))</td>
                                <td>@trendyolProduct.StockQuantity</td>
                                <td>@trendyolProduct.Status</td>
                                <td style="text-align: center;">
                                    <button class="btn-action btn-action-update" onclick="openUpdateModal('@trendyolProduct.ProductId', this)">
                                        <i class="fa fa-edit"></i> Güncelle
                                    </button>
                                    <a class="btn-action btn-action-delete" href="/AdminTrendyol/DeleteTrendyolProduct/@trendyolProduct.ProductId?pazarYeriId=@ViewBag.PazarYeriId"
                                       onclick="return confirm('Bu ürünü silmek istediğinizden emin misiniz?');">
                                        <i class="fa fa-trash"></i> Sil
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="empty-state">
                    <i class="fa fa-shopping-cart"></i>
                    <h4>Henüz ürün bulunamadı</h4>
                    <p>Trendyol ürünlerinizi eklemek için "Ürün Ekle" butonunu kullanabilirsiniz.</p>
                </div>
            }
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Yeni Ürün Ekle</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="form-row row">
                            <div class="form-group col-md-6">
                                <label for="tr_title">Ürün Adı</label>
                                <input type="text" class="form-control" id="tr_title" name="tr_title">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="tr_barcode">Barkod</label>
                                <input type="text" class="form-control" id="tr_barcode" name="tr_barcode">
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-6">
                                <label for="tr_stockQuantity">Stok Miktarı</label>
                                <input type="number" class="form-control" id="tr_stockQuantity" name="tr_stockQuantity">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="tr_salePrice">Satış Fiyatı (TL)</label>
                                <input type="text" class="form-control" id="tr_salePrice" name="tr_salePrice">
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-6">
                                <label for="tr_listPrice">Piyasa Fiyatı (TL)</label>
                                <input type="text" class="form-control" id="tr_listPrice" name="tr_listPrice">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="tr_vatRate">KDV Oranı (%)</label>
                                <input type="number" class="form-control" id="tr_vatRate" name="tr_vatRate">
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-12">
                                <label for="tr_categoryId">Kategori</label>
                                <select class="form-control" id="tr_categoryId" name="tr_categoryId">
                                    <option value="">Kategori Seçin</option>
                                    @foreach (var category in ViewBag.Categories)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-12">
                                <label for="tr_description">Açıklama</label>
                                <textarea class="form-control" id="tr_description" name="tr_description"></textarea>
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-12">
                                <label for="tr_imageUrl">Görsel URL</label>
                                <input type="text" class="form-control" id="tr_imageUrl" name="tr_imageUrl">
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-modern">Ekle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Product Modal -->
    <div class="modal fade" id="updateProductModal" tabindex="-1" role="dialog" aria-labelledby="updateProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateProductModalLabel">Ürün Güncelle</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="updateProductForm">
                        <input type="hidden" id="tr_updateProductId" name="tr_updateProductId">
                        <div class="form-row row">
                            <div class="form-group col-md-6">
                                <label for="tr_updateTitle">Ürün Adı</label>
                                <input type="text" class="form-control" id="tr_updateTitle" name="tr_updateTitle">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="tr_updateBarcode">Barkod</label>
                                <input type="text" class="form-control" id="tr_updateBarcode" name="tr_updateBarcode">
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-6">
                                <label for="tr_updateStockQuantity">Stok Miktarı</label>
                                <input type="number" class="form-control" id="tr_updateStockQuantity" name="tr_updateStockQuantity">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="tr_updateSalePrice">Satış Fiyatı (TL)</label>
                                <input type="text" class="form-control" id="tr_updateSalePrice" name="tr_updateSalePrice">
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-6">
                                <label for="tr_updateListPrice">Piyasa Fiyatı (TL)</label>
                                <input type="text" class="form-control" id="tr_updateListPrice" name="tr_updateListPrice">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="tr_updateVatRate">KDV Oranı (%)</label>
                                <input type="number" class="form-control" id="tr_updateVatRate" name="tr_updateVatRate">
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-12">
                                <label for="tr_updateCategoryId">Kategori</label>
                                <select class="form-control" id="tr_updateCategoryId" name="tr_updateCategoryId">
                                    <option value="">Kategori Seçin</option>
                                    @foreach (var category in ViewBag.Categories)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-12">
                                <label for="tr_updateDescription">Açıklama</label>
                                <textarea class="form-control" id="tr_updateDescription" name="tr_updateDescription"></textarea>
                            </div>
                        </div>
                        <div class="form-row row">
                            <div class="form-group col-md-12">
                                <label for="tr_updateImageUrl">Görsel URL</label>
                                <input type="text" class="form-control" id="tr_updateImageUrl" name="tr_updateImageUrl">
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-modern">Güncelle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@section Script {
    <script>
        $(document).ready(function () {
            if ($.fn.DataTable && $('#TblVeriler').length > 0) {
                $('#TblVeriler').DataTable({
                    "language": {
                        "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Turkish.json"
                    },
                    "pageLength": 10,
                    "order": [[0, "desc"]],
                    "responsive": true,
                    "bDestroy": true
                });
            }

            $('#addProductForm').submit(function (e) {
                e.preventDefault();
                var pazarYeriId = @ViewBag.PazarYeriId;
                var productData = {
                    Title: $('#tr_title').val(),
                    Barcode: $('#tr_barcode').val() || null,
                    StockQuantity: parseInt($('#tr_stockQuantity').val()),
                    SalePrice: parseFloat($('#tr_salePrice').val().replace(',', '.')),
                    ListPrice: parseFloat($('#tr_listPrice').val().replace(',', '.')),
                    Description: $('#tr_description').val(),
                    ImageUrl: $('#tr_imageUrl').val() || null,
                    CategoryId: parseInt($('#tr_categoryId').val()),
                    VatRate: parseInt($('#tr_vatRate').val())
                };

                $.ajax({
                    url: '/AdminTrendyol/AddTrendyolProduct?pazarYeriId=' + pazarYeriId,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function (response) {
                        if (response.success) {
                            alert('Ürün başarıyla eklendi: ' + response.message);
                            $('#addProductModal').modal('hide');
                            location.reload();
                        } else {
                            alert('Hata: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Hata: ' + error);
                    }
                });
            });

            $('#updateProductForm').submit(function (e) {
                e.preventDefault();
                var pazarYeriId = @ViewBag.PazarYeriId;
                // Ensure productData matches TrendyolProductRequest model exactly
                var productData = {
                    ProductId: $('#tr_updateProductId').val() || null, // Ensure ProductId is included
                    Title: $('#tr_updateTitle').val() || '',
                    Barcode: $('#tr_updateBarcode').val() || null,
                    StockQuantity: parseInt($('#tr_updateStockQuantity').val()) || 0,
                    SalePrice: parseFloat($('#tr_updateSalePrice').val().replace(',', '.')) || 0,
                    ListPrice: parseFloat($('#tr_updateListPrice').val().replace(',', '.')) || 0,
                    Description: $('#tr_updateDescription').val() || '',
                    ImageUrl: $('#tr_updateImageUrl').val() || null,
                    CategoryId: parseInt($('#tr_updateCategoryId').val()) || 0,
                    VatRate: parseInt($('#tr_updateVatRate').val()) || 0
                };

                $.ajax({
                    url: '/AdminTrendyol/UpdateTrendyolProduct?pazarYeriId=' + pazarYeriId,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function (response) {
                        if (response.success) {
                            alert('Ürün başarıyla güncellendi: ' + response.message);
                            $('#updateProductModal').modal('hide');
                            location.reload();
                        } else {
                            alert('Hata: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Hata: ' + error);
                    }
                });
            });

            window.openUpdateModal = function (productId, button) {
                var productData = $(button).closest('tr').data('product');
                $('#tr_updateProductId').val(productData.ProductId);
                $('#tr_updateTitle').val(productData.Title);
                $('#tr_updateBarcode').val(productData.Barcode);
                $('#tr_updateStockQuantity').val(productData.StockQuantity);
                $('#tr_updateSalePrice').val(productData.SalePrice);
                $('#tr_updateListPrice').val(productData.ListPrice);
                $('#tr_updateDescription').val(productData.Description);
                $('#tr_updateImageUrl').val(productData.ImageUrl);
                $('#tr_updateCategoryId').val(productData.CategoryId);
                $('#tr_updateVatRate').val(productData.VatRate);
                $('#updateProductModal').modal('show');
            };
        });
    </script>
}