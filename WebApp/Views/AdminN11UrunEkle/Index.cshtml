@using System.Globalization
@using Newtonsoft.Json
@using WebApp.Models

@{
    ViewData["Title"] = "N11 Ürün Ekle";
    Layout = "~/Views/Shared/_LayoutWebAdmin.cshtml";
}

<style>
    .modern-wrapper {
        padding: 20px;
    }

    .modern-panel {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        margin: 30px 0;
        transition: box-shadow 0.3s ease;
    }

        .modern-panel:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

    .panel-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .panel-content {
        padding: 20px;
    }

    .btn-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

    .form-group {
        margin-bottom: 15px;
    }

    .form-control {
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        padding: 8px;
        width: 100%;
    }

    .category-select-btn {
        width: 100%;
        text-align: left;
    }

    .modal-content {
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 12px 20px;
    }

    .modal-body {
        padding: 20px;
    }

    #categoryTree {
        max-height: 400px;
        overflow-y: auto;
    }

    .category-container {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 8px;
    }

    .category-leaf-item {
        padding: 8px 12px;
        background-color: #d1e7dd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }

        .category-leaf-item:hover {
            background-color: #a3cfbb;
        }

        .category-leaf-item.selected {
            background-color: #2d8b4e;
            color: white;
        }

    .category-separator {
        color: #6c757d;
        margin: 0 5px;
    }

    media (max-width: 768px) {
        .form-group

    {
        margin-bottom: 10px;
    }

    .form-control {
        padding: 6px;
    }

    }
</style>

<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-treeview/1.2.0/jquery.treeview.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-treeview/1.2.0/jquery.treeview.min.js"></script>

<section class="modern-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <div class="modern-panel">
                <div class="panel-header">
                    <i class="fa fa-plus"></i>
                    <span>N11 Ürün Ekle</span>
                </div>
                <div class="panel-content">
                    <form id="addProductForm" class="form-row" enctype="multipart/form-data">
                        <input type="hidden" id="pazarYeriId" value="@ViewBag.SelectedPazarYeriId">
                        <div class="form-group col-md-6">
                            <label for="n11_title">Ürün Adı</label>
                            <input type="text" class="form-control" id="n11_title" name="n11_title">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_description">Açıklama</label>
                            <textarea class="form-control" id="n11_description" name="n11_description" style="height: 100px;"></textarea>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_categoryId">Kategori ID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="n11_categoryId" name="n11_categoryId" readonly>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-modern category-select-btn" data-toggle="modal" data-target="#categoryModal">
                                        Kategori Seç
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_currencyType">Para Birimi</label>
                            <select class="form-control" id="n11_currencyType" name="n11_currencyType">
                                <option value="TL">TL</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_productMainId">Ürün Ana ID</label>
                            <input type="text" class="form-control" id="n11_productMainId" name="n11_productMainId">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_preparingDay">Kargoya Hazırlık Süresi (Gün)</label>
                            <input type="number" class="form-control" id="n11_preparingDay" name="n11_preparingDay" min="1">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_shipmentTemplate">Kargo Şablonu</label>
                            <select class="form-control" id="n11_shipmentTemplate" name="n11_shipmentTemplate">
                                <option value="">Kargo Şablonu Seçin</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_maxPurchaseQuantity">Maksimum Satın Alım Adedi</label>
                            <input type="number" class="form-control" id="n11_maxPurchaseQuantity" name="n11_maxPurchaseQuantity" min="1">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_stockCode">Stok Kodu</label>
                            <input type="text" class="form-control" id="n11_stockCode" name="n11_stockCode">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_barcode">Barkod</label>
                            <input type="text" class="form-control" id="n11_barcode" name="n11_barcode">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_quantity">Stok Miktarı</label>
                            <input type="number" class="form-control" id="n11_quantity" name="n11_quantity" min="1">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_images">Görseller</label>
                            <input type="file" class="form-control" id="n11_images" name="n11_images" accept="image/*" multiple>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_salePrice">Satış Fiyatı</label>
                            <input type="number" class="form-control" id="n11_salePrice" name="n11_salePrice" min="0" step="0.01">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_listPrice">Liste Fiyatı</label>
                            <input type="number" class="form-control" id="n11_listPrice" name="n11_listPrice" min="0" step="0.01">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="n11_vatRate">KDV Oranı</label>
                            <select class="form-control" id="n11_vatRate" name="n11_vatRate">
                                <option value="0">0%</option>
                                <option value="1">1%</option>
                                <option value="10">10%</option>
                                <option value="20">20%</option>
                            </select>
                        </div>

                        <div class="form-group col-12">
                            <button type="submit" class="btn btn-modern">Ekle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Selection Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">Kategori Seç</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="text" class="form-control" id="categorySearch" placeholder="Kategori ara...">
                    </div>
                    <div id="categoryTree" class="category-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-modern" data-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
</section>

@section Script {
    <script>
        $(document).ready(function () {
            var pazarYeriId = $('#pazarYeriId').val();
            var allCategories = [];
            var leafCategories = [];

            // Modal açıldığında kategorileri yükle
            $('#categoryModal').on('shown.bs.modal', function () {
                if (allCategories.length === 0 && pazarYeriId) {
                    loadN11Categories(pazarYeriId);
                }
            });

            function loadShipmentTemplates(pazarYeriId) {
                $.ajax({
                    url: '/AdminN11UrunEkle/GetN11ShipmentTemplates?pazarYeriId=' + pazarYeriId,
                    type: 'GET',
                    success: function (response) {
                        if (response.success) {
                            var $select = $('#n11_shipmentTemplate');
                            $select.empty();
                            $select.append('<option value="">Kargo Şablonu Seçin</option>');
                            response.shipmentTemplates.forEach(function (template) {
                                $select.append($('<option>').val(template).text(template));
                            });
                        } else {
                            console.error('Kargo şablonları yüklenemedi: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Kargo şablonları yüklenemedi: ' + error);
                    }
                });
            }

            // Kargo şablonlarını yükle
            loadShipmentTemplates(pazarYeriId);

            function loadN11Categories(pazarYeriId) {
                $.ajax({
                    url: '/AdminN11UrunEkle/GetN11Categories?pazarYeriId=' + pazarYeriId,
                    type: 'GET',
                    success: function (response) {
                        if (response.success) {
                            allCategories = response.categories;
                            leafCategories = extractLeafCategories(allCategories);
                            renderCategoryTree(leafCategories);
                        } else {
                            alert('Kategoriler yüklenemedi: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert('Kategoriler yüklenemedi: ' + error);
                    }
                });
            }

            function extractLeafCategories(categories, parentPath = []) {
                var leaves = [];

                categories.forEach(function (category) {
                    var currentPath = [...parentPath, category];

                    if (category.isLeaf) {
                        leaves.push({
                            id: category.id,
                            fullPath: currentPath
                        });
                    }

                    if (category.subCategories && category.subCategories.length > 0) {
                        leaves = leaves.concat(extractLeafCategories(category.subCategories, currentPath));
                    }
                });

                return leaves;
            }

            function renderCategoryTree(leaves) {
                var $container = $('#categoryTree');
                $container.empty();

                if (!leaves || leaves.length === 0) {
                    $container.append('<div class="text-muted">Kategori bulunamadı</div>');
                    return;
                }

                leaves.forEach(function (leaf) {
                    var $item = $('<div class="category-leaf-item">');

                    leaf.fullPath.forEach((cat, index) => {
                        $item.append($('<span>').text(cat.name));
                        if (index < leaf.fullPath.length - 1) {
                            $item.append($('<span class="category-separator">').text('>'));
                        }
                    });

                    $item.on('click', function () {
                        $('.category-leaf-item').removeClass('selected');
                        $(this).addClass('selected');
                        $('#n11_categoryId').val(leaf.id);
                    });

                    $item.on('dblclick', function () {
                        $('#categoryModal').modal('hide');
                    });

                    $container.append($item);
                });
            }

            $('#categorySearch').on('input', function () {
                var searchTerm = $(this).val().toLowerCase();
                if (searchTerm && allCategories.length === 0 && pazarYeriId) {
                    loadN11Categories(pazarYeriId);
                } else if (leafCategories.length > 0) {
                    if (searchTerm === '') {
                        renderCategoryTree(leafCategories);
                        return;
                    }

                    var filtered = leafCategories.filter(function (leaf) {
                        var fullPath = leaf.fullPath.map(c => c.name).join(' > ').toLowerCase();
                        return fullPath.includes(searchTerm);
                    });

                    renderCategoryTree(filtered);
                }
            });

        $('#addProductForm').submit(function (e) {
            e.preventDefault();
            console.log('Form submission triggered');

            var pazarYeriId = $('#pazarYeriId').val();
            console.log('pazarYeriId:', pazarYeriId);

            if (!pazarYeriId) {
                alert('Lütfen bir pazar yeri seçin.');
                return;
            }

            var formData = new FormData();

            formData.append('title', $('#n11_title').val());
            formData.append('description', $('#n11_description').val());

            var categoryId = parseInt($('#n11_categoryId').val());
            formData.append('categoryId', isNaN(categoryId) ? 0 : categoryId);

            formData.append('currencyType', $('#n11_currencyType').val());
            formData.append('productMainId', $('#n11_productMainId').val());

            var preparingDay = parseInt($('#n11_preparingDay').val());
            formData.append('preparingDay', isNaN(preparingDay) ? 1 : preparingDay);

            formData.append('shipmentTemplate', $('#n11_shipmentTemplate').val());

            var maxPurchaseQty = $('#n11_maxPurchaseQuantity').val();
            formData.append('maxPurchaseQuantity', maxPurchaseQty === "" ? null : parseInt(maxPurchaseQty));

            formData.append('stockCode', $('#n11_stockCode').val());

            var barcode = $('#n11_barcode').val();
            formData.append('barcode', barcode === "" ? null : barcode);

            var quantity = parseInt($('#n11_quantity').val());
            formData.append('quantity', isNaN(quantity) ? 1 : quantity);

            var salePrice = parseFloat($('#n11_salePrice').val());
            if (isNaN(salePrice) || salePrice <= 0) {
                alert("Geçerli bir satış fiyatı giriniz.");
                return;
            }
            formData.append('salePrice', salePrice);

            var listPrice = parseFloat($('#n11_listPrice').val());
            formData.append('listPrice', isNaN(listPrice) ? 0 : listPrice);

            var vatRate = parseInt($('#n11_vatRate').val());
            formData.append('vatRate', isNaN(vatRate) ? 0 : vatRate);

            // Handle multiple file uploads
            var files = $('#n11_images')[0].files;
            for (var i = 0; i < files.length; i++) {
                formData.append('Images', files[i]);
            }

            // DEBUG: FormData log
            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            $.ajax({
                url: '/AdminN11UrunEkle/AddN11Product?pazarYeriId=' + pazarYeriId,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log('Success:', response);
                    if (response.success) {
                        alert('Ürün başarıyla eklendi: ' + response.message);
                        $('#addProductForm')[0].reset();
                        location.reload();
                    } else {
                        alert('Hata: ' + response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                    alert('Hata oluştu: ' + error);
                }
            });
        });                });
    </script>
}